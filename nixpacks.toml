[phases.setup]
nixPkgs = ["php83", "sqlite"]

[phases.install]
cmds = [
  "curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer",
  "php /usr/local/bin/composer install --no-dev --optimize-autoloader",
  "mkdir -p /app/database",
  "mkdir -p /app/storage/logs",
  "mkdir -p /app/storage/framework/cache",
  "mkdir -p /app/storage/framework/sessions",
  "mkdir -p /app/storage/framework/views",
  "mkdir -p /app/bootstrap/cache",
  "cp .env.example .env"
]

[phases.build]
cmds = [
  "php artisan config:cache",
  "php artisan route:cache",
  "php artisan view:cache"
]

[start]
cmd = "sh -c 'echo \"üöÄ Laravel ERP starting...\" && php -r \"file_put_contents(\\\".env\\\", \\\"APP_NAME=\\\\\\\"Laravel ERP\\\\\\\"\\\\nAPP_ENV=production\\\\nAPP_DEBUG=false\\\\nAPP_URL=https://metalu.bytea.cl\\\\nDB_CONNECTION=sqlite\\\\nDB_DATABASE=database/database.sqlite\\\\n\\\");\" && if [ ! -f /app/database/database.sqlite ]; then sqlite3 /app/database/database.sqlite VACUUM; fi && chown -R www-data:www-data /app && chmod -R 755 /app && chmod -R 775 /app/storage /app/bootstrap/cache /app/database && chmod 666 /app/database/database.sqlite 2>/dev/null || true && php artisan key:generate --force && php artisan migrate --force && echo \"üåê Starting Laravel server on port 9000...\" && php artisan serve --host=0.0.0.0 --port=9000'"

[variables]
APP_ENV = "production"
APP_DEBUG = "false"
APP_URL = "https://metalu.bytea.cl"
DB_CONNECTION = "sqlite"
DB_DATABASE = "database/database.sqlite"