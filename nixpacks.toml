[phases.setup]
nixPkgs = ["php83", "php83Extensions.sqlite3", "sqlite3"]
aptPkgs = ["sqlite3"]

[phases.install]
cmds = [
  "composer install --no-dev --optimize-autoloader",
  "php artisan key:generate",
  "php artisan migrate --force",
  "php artisan storage:link",
  "php artisan cache:clear",
  "php artisan config:clear",
  "php artisan route:clear",
  "php artisan view:clear"
]

[phases.build]
cmds = [
  "php artisan config:cache",
  "php artisan route:cache",
  "php artisan view:cache"
]

[phases.start]
cmds = [
  "mkdir -p /app/storage/logs",
  "mkdir -p /app/database",
  "if [ ! -f /app/database/database.sqlite ]; then sqlite3 /app/database/database.sqlite 'VACUUM;'; fi",
  "chown -R www-data:www-data /app",
  "chmod -R 775 /app/storage /app/bootstrap/cache /app/database",
  "chmod 666 /app/database/database.sqlite 2>/dev/null || true",
  "php-fpm"
]

[start]
cmd = "php-fpm"

[variables]
APP_ENV = "production"
APP_DEBUG = "false"
APP_URL = "https://metalu.bytea.cl"
DB_CONNECTION = "sqlite"
DB_DATABASE = "/app/database/database.sqlite"
CACHE_DRIVER = "database"
SESSION_DRIVER = "database"