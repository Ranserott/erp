[phases.setup]
nixPkgs = ["php83", "sqlite", "nodejs_20"]

[phases.install]
cmds = [
  "curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer",
  "curl -fsSL https://deb.nodesource.com/setup_20.x | bash -",
  "apt-get update && apt-get install -y nodejs",
  "php /usr/local/bin/composer install --no-dev --optimize-autoloader",
  "npm install",
  "npm run build",
  "mkdir -p /app/database",
  "mkdir -p /app/storage/logs",
  "mkdir -p /app/storage/framework/cache",
  "mkdir -p /app/storage/framework/sessions",
  "mkdir -p /app/storage/framework/views",
  "mkdir -p /app/bootstrap/cache",
  "cp .env.example .env",
  "sed -i 's|APP_ENV=.*|APP_ENV=production|' .env && sed -i 's|APP_DEBUG=.*|APP_DEBUG=false|' .env && sed -i 's|APP_URL=.*|APP_URL=https://metalu.bytea.cl|' .env && sed -i 's|DB_CONNECTION=.*|DB_CONNECTION=sqlite|' .env && sed -i 's|DB_DATABASE=.*|DB_DATABASE=database/database.sqlite|' .env",
  "sqlite3 /app/database/database.sqlite 'VACUUM;' || true",
  "chown -R www-data:www-data /app",
  "chmod -R 755 /app",
  "chmod -R 775 /app/storage /app/bootstrap/cache /app/database",
  "chmod 666 /app/database/database.sqlite 2>/dev/null || true",
  "php artisan key:generate --force",
  "php artisan migrate --force",
  "php artisan tinker --execute=\"User::create(['name' => 'Admin', 'email' => 'admin@metalu.bytea.cl', 'password' => Hash::make('admin123', []), 'email_verified_at' => now()]);\""
]

[phases.build]
cmds = [
  "php artisan config:cache",
  "php artisan route:cache",
  "php artisan view:cache"
]

[start]
cmd = "php artisan serve --host=0.0.0.0 --port=9000"

