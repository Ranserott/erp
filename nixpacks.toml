[phases.setup]
nixPkgs = ["php83", "sqlite"]

[phases.install]
cmds = [
  "curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer",
  "php /usr/local/bin/composer install --no-dev --optimize-autoloader",
  "mkdir -p /app/database",
  "mkdir -p /app/storage/logs",
  "mkdir -p /app/storage/framework/cache",
  "mkdir -p /app/storage/framework/sessions",
  "mkdir -p /app/storage/framework/views",
  "mkdir -p /app/bootstrap/cache"
]

[phases.build]
cmds = [
  "php artisan config:cache",
  "php artisan route:cache",
  "php artisan view:cache"
]

[start]
cmd = """
#!/bin/bash
set -e

echo "ğŸš€ Iniciando Laravel ERP..."
echo "ğŸ“ Directorio actual: $(pwd)"
echo "ğŸ“ Contenido de /app:"
ls -la /app

# Create database if not exists
if [ ! -f /app/database/database.sqlite ]; then
    echo "ğŸ“ Creando base de datos SQLite..."
    mkdir -p /app/database
    sqlite3 /app/database/database.sqlite 'VACUUM;'
    chmod 666 /app/database/database.sqlite
    echo "âœ… Base de datos creada"
else
    echo "âœ… Base de datos ya existe"
fi

echo "ğŸ“Š Estado de la base de datos:"
ls -lh /app/database/database.sqlite 2>/dev/null || echo "âš ï¸  No se encuentra database.sqlite"

# Set permissions
echo "ğŸ” Configurando permisos..."
chown -R www-data:www-data /app
chmod -R 755 /app
chmod -R 775 /app/storage /app/bootstrap/cache /app/database
chmod 666 /app/database/database.sqlite 2>/dev/null || true

# Check if composer dependencies exist
if [ ! -d /app/vendor ]; then
    echo "âŒ ERROR: No se encuentra directorio vendor/"
    exit 1
fi

echo "âœ… Vendor encontrado: $(ls -la /app/vendor | wc -l) archivos"

# Generate key and migrate
echo "ğŸ”‘ Configurando Laravel..."
php artisan key:generate --force
echo "ğŸ“‹ Ejecutando migraciones..."
php artisan migrate --force

echo "ğŸŒ Iniciando servidor Laravel en http://0.0.0.0:9000"
echo "ğŸŒ APP_URL: ${APP_URL:-no definida}"

# Start server and keep it running
exec php artisan serve --host=0.0.0.0 --port=9000
"""

[variables]
APP_ENV = "production"
APP_DEBUG = "false"
APP_URL = "https://metalu.bytea.cl"
DB_CONNECTION = "sqlite"
DB_DATABASE = "/app/database/database.sqlite"
CACHE_DRIVER = "database"
SESSION_DRIVER = "database"